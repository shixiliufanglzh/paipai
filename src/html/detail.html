<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>商品详情</title>
    <script>
        (function (doc, win) {
            var docEl = doc.documentElement,
                    resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
                    recalc = function () {
                        var clientWidth = docEl.clientWidth;
                        if (!clientWidth) return;
                        if(clientWidth>=640){
                            docEl.style.fontSize = '100px';
                        }else{
                            docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
                        }
                    };

            if (!doc.addEventListener) return;
            win.addEventListener(resizeEvt, recalc, false);
            doc.addEventListener('DOMContentLoaded', recalc, false);
        })(document, window);
    </script>
    <link rel="stylesheet" href="../../bower_components/swiper/dist/css/swiper.min.css">
    <link rel="stylesheet" href="../style/detail.css">
</head>
<body>
<div id="goodDetail">
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <div class="swiper-slide"></div>
        </div>
        <div class="swiper-pagination"></div>
    </div>

    <section id="summary">
        <p class="desc">加载中...</p>
        <div class="price_now">
            <span class="cur_price">￥0.00</span>
            <!--<span class="rate">减价频率：1次/S&nbsp;&nbsp;&nbsp;&nbsp;减价幅度：0.01元/次</span>-->
            <!--<span class="rate">减价抢拍时间：(每天8:00-24:00)</span>-->
            <span class="rate">距正式减拍还有<span class="left_time">0天0时0分0秒</span></span>
        </div>
        <div class="relevant_price clearfix">
            <span class="primary">起拍价：<span class="primary_range">￥0.00-0.00</span></span>
            <span class="market">市场价：<span class="market_range">￥0.00-0.00</span></span>
        </div>
        <div class="relevant_count clearfix">
            <span class="store">库存：<span class="store_count">9999件</span></span>
            <span class="sold">已拍：<span class="sold_count">999件</span></span>
        </div>
    </section>

    <section id="features" class="clearfix">
        <div><i></i><span>正品保证</span></div>
        <div><i></i><span>公正公开</span></div>
        <div><i></i><span>七天退换</span></div>
        <div><i></i><span>闪电发货</span></div>
    </section>

    <section id="production">
        <div class="sorts_sel"><span>选择分类</span><i></i></div>
        <div class="rule">
            <h5>抢拍规则</h5>
            <div class="rule_content">
                <div class="single_rule">
                    <h6><i class="one"></i><span>正价减拍</span></h6>
                    <p>商品由正价开始减价，每隔一段时间减价一次</p>
                </div>
                <div class="single_rule">
                    <h6><i class="two"></i><span>先拍先得</span></h6>
                    <p>商品减价过程中，首个抢拍的买家，即以当前价成交</p>
                </div>
                <div class="single_rule">
                    <h6><i class="three"></i><span>循环反复</span></h6>
                    <p>抢拍成功后，商品重新从正价开始减价，进入新的抢拍</p>
                </div>
            </div>
        </div>
    </section>

    <section id="about">
        <div class="nav">
            <div class="tab tab_good_detail current">商品详情</div>
            <div class="tab tab_deal_record">成交记录</div>
            <div class="tab tab_evaluate_list">用户评价</div>
        </div>
        <div class="about_sorts">
            <div class="good_detail"></div>

            <div class="deal_record">
                <!--<div class="single_deal">-->
                    <!--<div class="deal_msg"><span class="name">136****5342</span><span class="time">2017-08-15 08:28</span></div>-->
                    <!--<div class="deal_detail">-->
                        <!--<span class="deal_price">￥3999.23</span>-->
                        <!--<p class="parameter">颜色：黄绿色 尺寸：235L 型号：SFGGR25ac</p>-->
                        <!--<p class="count">数量：1</p>-->
                    <!--</div>-->
                <!--</div>-->
            </div>

            <div class="evaluate_list">
                <!--<div class="single_evaluate">-->
                    <!--<div class="evaluate_msg"><span class="name">136****5342</span><span class="time">2017-08-15 08:28</span></div>-->
                    <!--<p class="evaluate_content">啊大煞风景哈斯看见的恢复开机开机速度封口机哈萨克交电话费客家话代课教师当时的解放军爱死基地</p>-->
                    <!--&lt;!&ndash;<div class="imgs"><span></span><span></span><span></span><span></span></div>&ndash;&gt;-->
                    <!--<p class="good_para">颜色分类：E90无花是实惠色 颜色分类：E90无花是实惠色</p>-->
                <!--</div>-->

            </div>
            <div class="loading"><i></i><span>加载中...</span></div>
        </div>
    </section>

    <div id="action">
        <div class="action_wrap">
            <button class="chat"><i></i></button>
            <button class="like"><i></i><span>加入关注</span></button>
            <button class="purchase"><i></i><span>正价购买</span></button>
        </div>
    </div>
</div>

<div id="sortsList">
    <div class="sorts_wrap">
        <i class="close"></i>
        <div class="good_img"></div>
        <div class="basic_para">
            <div class="cur_price">当前价：<span>￥0.00</span></div>
            <div class="start_price">起拍价：<span>￥0.00</span></div>
            <div class="left_price">库&nbsp;&nbsp;&nbsp;存：<span>154564件</span></div>
        </div>

        <div class="parameters">
            <div class="sorts_para">
                <h6>请选择参数</h6>

            </div>

            <div class="count_sel clearfix">
                <div class="limit">购买数量<span></span></div>
                <div class="count">
                    <i class="minus"></i>
                    <span class="count_num">1</span>
                    <i class="plus"></i>
                </div>
            </div>

            <div class="consume">
                <h4>消耗</h4>
                <p><span class="consume_count">1</span>拍币（剩余<span class="current_left">111</span>拍币）</p>
            </div>
        </div>

        <div id="bottomBtn" class="intension">
            <button class="like">加入关注</button>
            <button class="purchase">立即竞拍</button>
        </div>
    </div>
</div>

</body>
<script src="../../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../../bower_components/swiper/dist/js/swiper.jquery.min.js"></script>
<script src="../script/paipaiCompnt.js"></script>
<script>
    var goodsPara,paraList,reloadMsg;
    var timer = null;
    var userSel = {
        count: 1,
        sku_id: [],
        spu_id: [],
        mixId: null
    };
    var $goodId;
    var finishLoading = true;
    var $pageSize = 12, $pageNum = 1;
    var $curAbout = 0;
    var hasPhone = false;


    $(function(){
        $('.loading').hide();

        $goodId = commonCompt.GetUrlPara('good_id');

        $.ajax({
            url: GETUSERINFO,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                console.log(data);
                apiResponse(data.responseCode,data.responseDesc,data.data);
                if(data.responseCode == 2000){
                    if(data.data.userTel){
                        hasPhone = true;
                    }
                    if(data.data.userPoint){
                        $('.current_left').html(data.data.userPoint);
                    }else {
                        $('.current_left').html(0);
                    }
                }
            },
            error: function (err) {
                console.log(err);
            }
        })

        $.ajax({
            url: GETGODDSDETAIL,
            type:'GET',
            dataType:'json',
            data: {goodsId: $goodId},
            success: function(data){
                console.log(data);
                apiResponse(data.responseCode,data.responseDesc,data.data);
                if(data.responseCode == 2000) {
                    goodsPara = data.data;
                    //价格、库存等信息展示
                    $('#summary .desc').html(goodsPara.goodsDesc);
                    $('#summary .primary_range').html('￥' + goodsPara.salePrice.toFixed(2));
                    $('#summary .market_range').html('￥' + goodsPara.marketPrice.toFixed(2));
                    $('#summary .sold_count').html(goodsPara.saleNum + '件');
                    $('#summary .cur_price').html('￥' + goodsPara.nowPrice.toFixed(2));
                    $('#sortsList .cur_price span').html('￥' + goodsPara.nowPrice.toFixed(2));
                    $('#sortsList .start_price span').html('￥' + goodsPara.salePrice.toFixed(2));
                    $('#sortsList .left_price span').html(goodsPara.stockNum + '件');
                    $('#sortsList .consume_count').html(goodsPara.pieNum);

                    if (goodsPara.limitNum > 0 && goodsPara.saleStatus == 1 && goodsPara.timeStatus == 1) {
                        $('#summary .store_count').html(goodsPara.stockNum + '件（每次限拍' + goodsPara.limitNum + '件,累计限拍' + goodsPara.totalLimitNum + '件）');
                        $('#sortsList .count_sel .limit span').html('（限购' + goodsPara.limitNum + '件,累计限拍' + goodsPara.totalLimitNum + '件）');

                    } else {
                        $('#summary .store_count').html(goodsPara.stockNum + '件');
                    }

                    var imgsCount = goodsPara.goodsPics.length;
                    $('.swiper-container .swiper-wrapper').html('');

                    $('#sortsList .good_img').css({
                        'background': 'url(' + goodsPara.goodsPic + ') center center no-repeat',
                        'background-size': 'cover',
                        '-webkit-background-size': 'cover'
                    })

                    for (var i = 0; i < imgsCount; i++) {
                        $('.swiper-container .swiper-wrapper').append('<div class="swiper-slide" style="background:url(' + goodsPara.goodsPics[i].goodsPic + ') center center no-repeat;background-size: cover;-webkit-background-size: cover;"></div>')
                    }
                    //轮播图
                    var mySwiper = new Swiper('.swiper-container', {
                        direction: 'horizontal',
                        loop: true,
                        autoplay: 3000,
                        pagination: '.swiper-pagination'
                    })


                    //判断是否在减价拍时间范围内
                    if (goodsPara.saleStatus == 1) {
                        if (goodsPara.timeStatus == 1) {
                            $('.action_wrap .purchase span').html('减价抢拍');
                            $('#sortsList .purchase').html('立即抢拍');
                            $('.rate').html('减价频率：1次/S&nbsp;&nbsp;&nbsp;&nb' +
                                    'sp;减价幅度：' + goodsPara.reducePrice + '元/次');
                        } else {
                            $('.action_wrap .purchase span').html('正价购买');
                            $('#sortsList .purchase').html('正价购买');
                            $('.rate').html('减价抢拍时间：(每天8:00-24:00)');
                        }



                    } else if (goodsPara.saleStatus == 2) {
                        //倒计时
                        var timerList = [];
                        var addOrderTimer = new Paipai;
                        addOrderTimer.addOrderTimer(goodsPara.timeLeft, $('.rate .left_time'), timerList);
                        $('.action_wrap .purchase span').html('正价购买');
                        $('#sortsList .purchase').html('正价购买');

                    } else if (goodsPara.saleStatus == 3) {
                        $('.action_wrap .purchase span').html('销售告罄');
                        $('.purchase').attr('disabled', 'disabled');
                        $('#sortsList .purchase').html('销售告罄');
                        $('.purchase').css('background-color', '#858585');
                        $('.rate').hide();
                    };

                    for (var i = 0; i < goodsPara.goodsDetailPics.length; i++) {
                        $('.about_sorts .good_detail').append('<img src="' + goodsPara.goodsDetailPics[i].goodsPic + '">')
                    }
                }
            },
            error: function(err){
                console.log(err);
            }
        });

        $.ajax({
            url: GETGODDSSKU,
            type:'GET',
            dataType:'json',
            data: {goodsId: $goodId},
            success: function(data){
                //商品规格参数展示
                apiResponse(data.responseCode,data.responseDesc,data.data);
                if(data.responseCode == 2000) {
                    console.log(data);
                    paraList = data.data;
                    for (var i = 0; i < paraList.length; i++) {
                        var paraWrapHtml = '';
                        paraWrapHtml += '<div class="single_para_container" data-sku-id="' + paraList[i].skuId + '">' +
                                '<h4>' + paraList[i].skuName + '</h4>' +
                                '<div class="sorts">';
                        for (var j = 0; j < paraList[i].goodsSpu.length; j++) {
                            var stock = "";
                            stock = paraList[i].goodsSpu[j].stockNum > 0 ? "" : "short";
                            paraWrapHtml += '<span class="' + stock + '" data-spu-id="' + paraList[i].goodsSpu[j].spuId + '">' + paraList[i].goodsSpu[j].spuName + '</span>';
                        }
                        paraWrapHtml += '</div>' +
                                '</div>';

                        $('#sortsList .sorts_para').append(paraWrapHtml);
                    }
                }

            },
            error: function(err){
                console.log(err);
            }
        });

        timer = setInterval(function () {
            if (goodsPara.saleStatus == 1 && goodsPara.timeStatus == 1) {
                if (goodsPara.nowPrice <= commonCompt.randomNum(goodsPara.limitPrice)) {
                    $.ajax({
                        url: REFRESHGOODS,
                        type: 'GET',
                        dataType: 'json',
                        data: {goodsId: $goodId, goodsIssueno: goodsPara.goodsIssueno},
                        async: false,
                        success: function (data) {
                            apiResponse(data.responseCode, data.responseDesc, data.data);
                            if (data.responseCode == 2000) {
                                location.reload(true);
                            }
                        },
                        error: function (err) {
                            console.log(err);
                        }
                    });
                }
                goodsPara.nowPrice = commonCompt.accSub(goodsPara.nowPrice, goodsPara.reducePrice);
                if(goodsPara.nowPrice <= 0){
                    goodsPara.nowPrice = 0;
                };
                $('#summary .cur_price').html('￥' + goodsPara.nowPrice.toFixed(2));
                $('#summary .sold_count').html(goodsPara.saleNum + '件');
                if (goodsPara.limitNum > 0 && goodsPara.saleStatus == 1 && goodsPara.timeStatus == 1) {
                    $('#summary .store_count').html(goodsPara.stockNum + '件（每次限拍' + goodsPara.limitNum + '件,累计限拍' + goodsPara.totalLimitNum + '件）');
                    $('#sortsList .count_sel .limit span').html('（限购' + goodsPara.limitNum + '件,累计限拍' + goodsPara.totalLimitNum + '件）');

                } else {
                    $('#summary .store_count').html(goodsPara.stockNum + '件');
                }
                if (paraList.length <= 0 || (paraList.length > 0 && userSel.spu_id.length < paraList.length)) {
                    $('#sortsList .cur_price span').html('￥' + goodsPara.nowPrice.toFixed(2));
                    $('#sortsList .start_price span').html('￥' + goodsPara.salePrice.toFixed(2));
                    $('#sortsList .left_price span').html(goodsPara.stockNum + '件');
                }
                if(reloadMsg){
                    reloadMsg.nowPrice = commonCompt.accSub(reloadMsg.nowPrice, goodsPara.reducePrice);
                    if(reloadMsg.nowPrice <= 0){
                        reloadMsg.nowPrice = 0;
                    };
                    $('#sortsList .cur_price span').html('￥' + reloadMsg.nowPrice.toFixed(2));
                    $('#sortsList .start_price span').html('￥' + reloadMsg.salePrice.toFixed(2));
                    $('#sortsList .left_price span').html(reloadMsg.stockNum + '件');
                }
            }

        }, 1000);
    })

    //开启/关闭 规格参数信息
    $('.action_wrap .like,.action_wrap .purchase,#production .sorts_sel').click(function(){
        $('#sortsList').fadeIn(300);
    })
    $('.close').click(function(){
        $('#sortsList').fadeOut(300);
    })
    $('#sortsList').click(function(e){
        if ($(e.target).is('.sorts_wrap')){
            return;
        }else {
            $('#sortsList').fadeOut(300);
        }
    })
    $('.sorts_wrap').click(function (e){
        e.stopPropagation();
    })




    //购买数量
    $('#sortsList .minus').click(function(){
        if(userSel.count > 1)  userSel.count --;
        $('#sortsList .count_num').html(userSel.count);
    })
    $('#sortsList .plus').click(function(){
        if(userSel.count < goodsPara.limitNum) userSel.count ++;
        $('#sortsList .count_num').html(userSel.count);
        console.log(userSel);
    })

    //选择参数
    $('#sortsList .sorts_para').on('click', 'span',function(){
        var $curClickParent = $(this).parents('.single_para_container');
        var skuIndex = $curClickParent.index() - 1;
        var spuIndex = $(this).index();
        console.log(skuIndex,spuIndex);
        if(!$(this).hasClass('short')){
            $(this).siblings('span').removeClass('selected');
            if(!$(this).hasClass('selected')){
                $(this).addClass('selected');
                if(paraList[skuIndex].goodsSpu[spuIndex].picUrl){
                    $('#sortsList .good_img').css({
                        'background': '#fff url('+ paraList[skuIndex].goodsSpu[spuIndex].picUrl +') center center no-repeat',
                        'background-size': 'cover',
                        '-webkit-background-size': 'cover'
                    })
                }
                var sku_id = $(this).parents('.single_para_container').attr('data-sku-id');
                var spu_id = $(this).attr('data-spu-id');
                var flag_exist = false;
                for(var i=0; i<userSel.sku_id.length; i++){
                    if(userSel.sku_id[i] == sku_id){
                        flag_exist = true;
                        userSel.spu_id[i] = spu_id;
                    }
                }
                if(!flag_exist){
                    userSel.sku_id.push(sku_id);
                    userSel.spu_id.push(spu_id);
                }
                //检查未选参数的库存
                checkStore();

            }else {
                $(this).removeClass('selected');
                for(var i=0; i<userSel.sku_id.length; i++){
                    if(userSel.sku_id[i] == $curClickParent.attr('data-sku-id')){
                        userSel.sku_id.splice(i,1);
                        userSel.spu_id.splice(i,1);
                        console.log(userSel.spu_id);
                    }
                }
                //检查参数的库存
                checkStore();
            }
        }

        console.log(userSel.spu_id);

        if(userSel.spu_id.length >= paraList.length){
            var $mixSkuId = userSel.spu_id.join(',');
            console.log($mixSkuId);
            $.ajax({
                url: GETGOODSMIXSKU,
                type:'GET',
                dataType:'json',
                data: {
                    goodsId: $goodId,
                    mixSkuId: $mixSkuId
                },
                success: function(data){
                    apiResponse(data.responseCode,data.responseDesc,data.data);
                    if(data.responseCode == 2000) {
                        reloadMsg = data.data;
                        userSel.mixId = reloadMsg.mixId

                        //价格、库存等信息展示
                        $('#sortsList .cur_price span').html('￥' + reloadMsg.nowPrice.toFixed(2));
                        $('#sortsList .start_price span').html('￥' + reloadMsg.salePrice.toFixed(2));
                        $('#sortsList .left_price span').html(reloadMsg.stockNum + '件');
                        if (!goodsPara.timeStatus || goodsPara.timeStatus != 1) {
                            goodsPara.limitNum = reloadMsg.stockNum;
                        }
                    }


                },
                error: function(err){
                    console.log(err);
                }
            });
        }

    })

    //商品详情、成交记录、用户评价 切换
    $('#about .nav').on('click','.tab',function(){
        $pageNum = 1;
        finishLoading = false;

        var curIndex = $(this).index();
        $curAbout = curIndex;
        $('#about .nav .tab').removeClass('current');
        $(this).addClass('current');
        $('.about_sorts>div').hide();
        $('.about_sorts>div').eq(curIndex).show();
        $('.about_sorts').css({'padding':'0'});

        if($(this).hasClass('tab_evaluate_list')){
            $('.about_sorts').css({'padding':'0.1rem 0.24rem'});
            $('.loading').show();
            showComments($pageNum);
        }else if($(this).hasClass('tab_deal_record')){
            $('.about_sorts').css({'padding':'0.1rem 0.24rem'});
            $('.loading').show();
            showDeals($pageNum);
        }
    })

    //评论列表展示
    function showComments(pageNum){

        finishLoading = true;
        $('.loading').hide();

        if(pageNum <= 1){
            $('.evaluate_list').html('');
        }
        $.ajax({
            url: GETGOODSCOMMENTS,
            type:'GET',
            dataType:'json',
            data: {
                goodsId: $goodId,
                pageNum: pageNum,
                pageSize: $pageSize
            },
            success: function(data){
                //商品规格参数展示
                apiResponse(data.responseCode,data.responseDesc,data.data);
                if(data.responseCode == 2000){
                    if(data.data && data.data.length > 0) {
                        var commentsList = data.data;
                        var commentsHtml = "";
                        for (var i = 0; i < commentsList.length; i++) {
                            commentsHtml += '<div class="single_evaluate">' +
                                    '<div class="evaluate_msg"><span class="name">' + commentsList[i].userTel + '</span><span class="time">' + commentsList[i].createDate + '</span></div>' +
                                    '<p class="evaluate_content">' + commentsList[i].content + '</p>' +
                                    '<div class="imgs">';
                            var comentsNum = commentsList[i].commentPic.length;
                            if (comentsNum > 0) {
                                for (var j = 0; j < comentsNum; j++) {
                                    commentsHtml += '<span style="background:url(' + commentsList[i].commentPic[j].picUrl + ') center center no-repeat;background-size: cover;-webkit-background-size: cover;"></span>'
                                }
                            };

                            commentsHtml += '</div>' +
                                    '<p class="good_para">' + commentsList[i].goodsSpu + '</p>' +
                                    '</div>';
                        }

                        $('.evaluate_list').append(commentsHtml);

                        if (commentsList.length < $pageSize) {
                            finishLoading = true;
                            $('.loading').hide();
                        } else {
                            $('.loading').show();
                            finishLoading = false;
                        }
                    }else {
                        $('.evaluate_list').html('<h4 style="font-size:0.24rem;text-align:center;color:#ccc;font-weight:500;">暂无评论</h4>')
                    }
                }
            },
            error: function(err){
                console.log(err);
            }
        });
    }

    //成交列表展示
    function showDeals(pageNum){

        finishLoading = true;
        $('.loading').hide();

        if(pageNum <= 1){
            $('.deal_record').html('');
        }
        $.ajax({
            url: GETBUYRECORD,
            type:'GET',
            dataType:'json',
            data: {
                goodsId: $goodId,
                pageNum: pageNum,
                pageSize: $pageSize
            },
            success: function(data){
                //商品规格参数展示
                apiResponse(data.responseCode,data.responseDesc,data.data);
                if(data.responseCode == 2000){
                    if(data.data && data.data.length > 0) {
                        var dealsList = data.data;
                        var dealsHtml = "";
                        for (var i = 0; i < dealsList.length; i++) {
                            dealsHtml += '<div class="single_deal">' +
                                    '<div class="deal_msg"><span class="name">' + dealsList[i].userTel + '</span><span class="time">' + dealsList[i].createDate + '</span></div>' +
                                    '<div class="deal_detail">' +
                                    '<span class="deal_price">￥' + dealsList[i].totalPrice.toFixed(2) + '</span>' +
                                    '<p class="parameter">' + dealsList[i].goodsSpu + '</p>' +
                                    '<p class="count">数量：' + dealsList[i].goodsAmount + '</p>' +
                                    '</div>' +
                                    '</div>'
                        }

                        $('.deal_record').append(dealsHtml);

                        if (dealsList.length < $pageSize) {
                            finishLoading = true
                            $('.loading').hide();
                        } else {
                            $('.loading').show();
                            finishLoading = false;
                        }
                    }else {
                        $('.deal_record').html('<h4 style="font-size:0.24rem;text-align:center;color:#ccc;font-weight:500;">暂无交易记录</h4>')
                    }
                }

            },
            error: function(err){
                console.log(err);
            }
        });
    }

    $(document).scroll(function(){

        //加载下一页
        if(!finishLoading && $(window).height() > $('.loading').offset().top - $(document).scrollTop() + $('#action').height()){
            if($curAbout == 2 && $('.single_evaluate').length >0){
                $pageNum ++;
                console.log("评论记录","第"+$pageNum+"页");
                finishLoading = true;
                setTimeout(function(){
                    showComments($pageNum);
                },1000);
            }else if($curAbout == 1 && $('.single_deal').length >0){
                $pageNum ++;
                console.log("交易记录","第"+$pageNum+"页");
                finishLoading = true;
                setTimeout(function(){
                    showDeals($pageNum);
                },1000);
            }
        }
    })

    //加入关注
    $('#bottomBtn .like').click(function() {
        if(userSel.spu_id.length >= paraList.length) {
            if(userSel.count > 0){
                var $mixSkuId = userSel.spu_id.join(',');
                var paraData = {
                        goodsId: $goodId,
                        mixId: userSel.mixId,
                        goodsAmount: userSel.count
                    }
                console.log(paraData);
                $.ajax({
                    url: ADDSTORE,
                    type: 'POST',
                    dataType: 'json',
                    data: paraData,
                    success: function (data) {
                        console.log(data);
                        apiResponse(data.responseCode,data.responseDesc,data.data);
                        if(data.responseCode == 2000){
                            commonCompt.popPrompt("已添加关注");
                        }

                    },
                    error: function (err) {
                        console.log(err);
                    }
                });
            }else {
                commonCompt.popPrompt('请选择数量');
            }
        }else {
            commonCompt.popPrompt('请选择参数');
        }
    })

    //立即购买
    $('#bottomBtn .purchase').click(function() {
        //如果是未绑定手机号的用户
        if(!hasPhone){
            hasPhone = commonCompt.verifyPhone(60,"新用户注册",true,3,"注册成功",null);
        }else {
            if (userSel.spu_id.length >= paraList.length) {
                if (userSel.count > 0) {
                    var paraData = {
                        goodsId: $goodId,
                        mixId: userSel.mixId,
                        goodsAmount: userSel.count,
                        goodsIssueno: goodsPara.goodsIssueno
                    }
//                    alert(JSON.stringify(paraData));
                    $.ajax({
                        url: ADDCART,
                        type: 'POST',
                        dataType: 'json',
                        data: paraData,
                        success: function (data) {
                            apiResponse(data.responseCode, data.responseDesc,data.data);
                            if (data.responseCode == 2000) {
                                commonCompt.Confirm({
                                    hasTitle: true,
                                    title: "提示",
                                    contentText: "恭喜您获得了这件商品的购买权",
                                    cancleText: "继续抢拍",
                                    certainText: "查看拍得",
                                    rightBtnClick: function(){
                                        window.location.href = 'orderGenerate.html';
                                    },
                                    leftBtnClick: function(){
                                        window.location.href = '../index.html';
                                    }
                                });
                            }

                        },
                        error: function (err) {
                            console.log(err);
                            commonCompt.popPrompt("购买失败，请刷新后再尝试");
                        }
                    });
                } else {
                    commonCompt.popPrompt('请选择数量');
                }
            } else {
                commonCompt.popPrompt('请选择参数');
            }
        }
    })

    $('.action_wrap .chat').click(function(){
        window.location.href = 'https://static.meiqia.com/dist/standalone.html?_=t&eid=82155'
    })

    //检查库存的方法
    function checkStore(){
        var paraDomList = $('.single_para_container .sorts span');
        var paraCombi = goodsPara.goodsSkuMix;

        for(var k=0; k<paraDomList.length; k++) {
            var ruleOutSku = [].concat(userSel.sku_id);
            var ruleOutSpu = [].concat(userSel.spu_id);
            for(var j=0; j<ruleOutSku.length; j++) {
                if (ruleOutSku[j] == paraDomList.eq(k).parents('.single_para_container').attr('data-sku-id')) {
                    ruleOutSku.splice(j, 1);
                    ruleOutSpu.splice(j, 1);
                }
            }
            for(var m=0; m<paraCombi.length; m++){
                if(commonCompt.isContained(paraCombi[m].mixSpuId,ruleOutSpu)
                        && commonCompt.isContained(paraCombi[m].mixSpuId,paraDomList.eq(k).attr('data-spu-id'))){
                    paraDomList.eq(k).removeClass('short');
                    break;
                }
                paraDomList.eq(k).addClass('short');
            }

        }
    }

    commonCompt.screenVisibleChange();

</script>
</html>